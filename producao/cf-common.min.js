(function () {
    try {
        let Common = {
            init: () => {
                Common.getOrderForm();
                Common.applyImageLoad();
                Common.handleNewsLetterForm();
                Common.removeLiCommentInAllShelfs();
                Common.triggerTotalItemsOrderForm();

                Common.toggleMenuMobile();
                if ($(window).width() <= 991) {
                    Common.toggleActiveSubmenus();
                } 

                Common.verifyLGPD();
                Common.configLGPD();
                Common.verifyPopupBeer();
                Common.configPopupBeer();
                
            },
            ajaxStop: () => { },
            data: {
                categories: null
            },
            regex: {
                domain: /\/https:\/\/casaflora.vtexcommercestable.com.br/g
            },
            getOrderForm: () => {
                vtexjs.checkout.getOrderForm().done(function (orderForm) {
                    Common.totalItemsOrderForm(orderForm);
                });
            },
            toggleActiveSubmenus: () => {
                $('.cf-header__menu.list').find('ul').slideUp();

                $('.icon-arrow').on('click', function () {
                    if ($(this).parent().parent().is(':not(.active)')) {
                        $(this)
                            .parent()
                            .parent()
                            .addClass('active')
                            .find(' > ul')
                            .slideDown('slow');
                    } else {
                        $(this)
                            .parent()
                            .parent()
                            .removeClass('active')
                            .find(' > ul')
                            .slideUp('slow');
                    }
                });
            },
            toggleMenuMobile: () => {
                $('.header__menu-icon').on('click', function () {
                    $('.cf-header__list-mobile').addClass('active');
                    $('body').addClass('overflowed');
                });
                $('.cf-header__list-mobileClose').on('click', function () {
                    $('.cf-header__list-mobile').removeClass('active');
                    $('body').removeClass('overflowed');
                });
            },
            totalItemsOrderForm: (of) => {
                if (!of.items.length) {
                    return;
                }

                let totalElement = $(".button__minicart-qty");
                let count = 0;
                of.items.forEach((item) => {
                    count = count + item.quantity;
                });
                totalElement.text(count);
            },
            triggerTotalItemsOrderForm: () => {
                let nameTrigger = "orderFormUpdated.vtex";
                $(window).on(nameTrigger, function(evt, newOrderForm) {
                    Common.totalItemsOrderForm(newOrderForm);
                });
            },
            handleNewsLetterForm: () => {
                var form = document.querySelector('#newsletter-form');
                if (form == null) {
                    return;
                }
                var listener = function (ev) {
                    ev.preventDefault();
                    var inputData = ev.target.querySelectorAll('input[name]');

                    //montando os dados pra enviar
                    var data = {};
                    inputData.forEach(function (input) {
                        data[input.name] = input.value;
                    });
                    //montando os dados pra enviar

                    Common.sendForm(data).done(function (response) {
                        swal({
                            title: 'Formulario enviado com sucesso!',
                            icon: 'success'
                        }).then(() => {
                            location.reload();
                        });
                    });
                };

                form.addEventListener('submit', listener, false);
            },
            sendForm: function (data) {
                let req = '/api/dataentities/NL/documents';
                const opts = {
                    type: 'PATCH',
                    url: req,
                    dataType: 'json',
                    headers: {
                        Accept: 'application/vnd.vtex.ds.v10+json',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    data: JSON.stringify(data)
                };

                return $.ajax(opts);
            },
            removeLiCommentInAllShelfs: () => {
                let wrapper = $('.prateleira ul');
                if (!wrapper.length) {
                    return;
                }
                wrapper.find('li[id]').each(function () {
                    $(this).remove();
                });
            },
            verifyLGPD: () => {
                if ($.cookie("OW_lgpd") == undefined) {
                    let wrapper = $(".orion-lgpd.main");
                    wrapper.show();
                }
            },
            configLGPD: () => {
                let wrapper = $(".orion-lgpd.main");
                let buttonLGPD = $("#pa-btn-lgpd-confirm");
                buttonLGPD.on("click", function () {
                    wrapper.hide("fast");
                    $.cookie("OW_lgpd", "true", { expires: 45 });
                });
            },
            verifyPopupBeer: () => {
                if ($.cookie("OW_beerValid") == undefined) {
                    let wrapper = $(".cf-popupolder.main");
                    let wrapperOverlay = $(".cf-bgpopup-overlay");

                    wrapper.removeClass("hide");
                    wrapperOverlay.removeClass("hide");
                }
            },
            configPopupBeer: () => {
                let wrapper = $(".cf-popupolder.main");
                let wrapperOverlay = $(".cf-bgpopup-overlay");
                let buttonPopupYes = $(".cf-popupolder.main a");
                buttonPopupYes.on("click", function () {
                    wrapper.addClass("hide");
                    wrapperOverlay.addClass("hide");

                    $.cookie("OW_beerValid", "true", { expires: 45 });
                });
            },
            applyImageLoad: () => {
                $(".ow-sfv-image-wrapper").OrionStoreFrontLazyLoad({
                    rangeThrottle: 15
                });
            }
        };

        // Instanciando a funcao
        $(document).ready(Common.init);
        $(document).ajaxStop(Common.ajaxStop);
    } catch (e) {
        console.log('Erro na inst√¢ncia do [Common]: ', e);
    }
})();
